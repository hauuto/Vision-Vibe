<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>X·ª≠ l√Ω ·∫¢nh - Vision Vibe</title>
    <style>
      /* CSS gi·ªØ nguy√™n */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px; /* TƒÉng width ƒë·ªÉ ch·ª©a 3 h√¨nh */
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        padding: 40px;
      }

      .upload-section {
        margin-bottom: 30px;
        text-align: center;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
      }

      .file-input {
        display: none;
      }

      .file-input-button {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.2s;
      }

      .file-input-button:hover {
        transform: translateY(-2px);
      }

      .method-selection {
        margin-bottom: 30px;
      }

      .method-selection h3 {
        margin-bottom: 15px;
        color: #333;
      }

      .method-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .method-btn {
        background: white;
        border: 2px solid #e0e0e0;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .method-btn:hover {
        border-color: #667eea;
        background: #f8f9ff;
      }

      .method-btn.active {
        border-color: #667eea;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .options-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .option-group {
        margin-bottom: 15px;
      }

      .checkbox-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .checkbox-wrapper input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
      }

      .checkbox-wrapper label {
        color: #333;
        font-weight: 500;
        cursor: pointer;
      }

      .gamma-control,
      .piecewise-control {
        margin-top: 15px;
        display: none;
      }

      .gamma-control.show,
      .piecewise-control.show {
        display: block;
      }

      .gamma-control label {
        display: block;
        margin-bottom: 5px;
        color: #333;
      }

      .gamma-control input {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        display: block;
      }

      .piecewise-graph-container {
        text-align: center;
        margin: 20px 0;
      }

      .piecewise-graph {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: crosshair;
        margin: 0 auto;
        display: block;
      }

      .piecewise-info {
        margin-top: 10px;
        padding: 15px;
        background: #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        color: #495057;
      }

      .point-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
      }

      .point-display {
        background: white;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      .reset-points-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
      }

      .reset-points-btn:hover {
        background: #5a6268;
      }

      .process-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 25px;
        font-size: 18px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .process-btn:hover {
        transform: translateY(-2px);
      }

      .process-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .images-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 30px;
        transition: all 0.3s ease;
      }

      .images-section.three-columns {
        grid-template-columns: 1fr 1fr 1fr;
      }

      .image-container {
        text-align: center;
      }

      .image-container h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 1.1em;
      }

      .image-display {
        width: 100%;
        max-width: 350px; /* Gi·∫£m m·ªôt ch√∫t ƒë·ªÉ fit 3 c·ªôt */
        height: 280px;
        border: 2px dashed #ddd;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        margin: 0 auto;
      }

      .image-display img {
        max-width: 100%;
        max-height: 100%;
        border-radius: 8px;
      }

      .placeholder {
        color: #999;
        font-size: 14px;
        text-align: center;
        padding: 20px;
      }

      /* Comparison Metrics Section */
      .comparison-section {
        margin-top: 40px;
        padding: 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid #dee2e6;
        display: none;
      }

      .comparison-section.show {
        display: block;
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .comparison-title {
        text-align: center;
        margin-bottom: 25px;
        color: #495057;
        font-size: 1.4em;
        font-weight: bold;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .metric-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-left: 4px solid;
        transition: transform 0.2s ease;
      }

      .metric-card:hover {
        transform: translateY(-2px);
      }

      .metric-card.mse {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
      }

      .metric-card.psnr {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #f8fff8 0%, #fff 100%);
      }

      .metric-card.ssim {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #fffef5 0%, #fff 100%);
      }

      .metric-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #212529;
        margin-bottom: 5px;
      }

      .metric-description {
        font-size: 12px;
        color: #6c757d;
        font-style: italic;
      }

      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        display: none;
      }

      .error.show {
        display: block;
      }

      @media (max-width: 1024px) {
        .images-section,
        .images-section.three-columns {
          grid-template-columns: 1fr 1fr;
        }
        
        .image-container:nth-child(3) {
          grid-column: 1 / -1;
          justify-self: center;
        }
      }

      @media (max-width: 768px) {
        .images-section,
        .images-section.three-columns {
          grid-template-columns: 1fr;
        }

        .method-buttons {
          grid-template-columns: 1fr;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .container {
          max-width: 100%;
          margin: 10px;
          border-radius: 10px;
        }

        .main-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîÆ Vision Vibe</h1>
        <p>X·ª≠ l√Ω ·∫¢nh v·ªõi Th·ªã gi√°c M√°y t√≠nh</p>
      </div>

      <div class="main-content">
        <!-- Upload Section -->
        <div class="upload-section">
          <div class="file-input-wrapper">
            <input
              type="file"
              id="imageInput"
              class="file-input"
              accept="image/*"
            />
            <button
              class="file-input-button"
              onclick="document.getElementById('imageInput').click()"
            >
              üìÅ Ch·ªçn ·∫¢nh
            </button>
          </div>
          <p>Ch·ªçn m·ªôt ·∫£nh ƒë·ªÉ x·ª≠ l√Ω (PNG, JPG, JPEG)</p>
        </div>

        <!-- Method Selection -->
        <div class="method-selection">
          <h3>üîß Ch·ªçn Ph∆∞∆°ng ph√°p X·ª≠ l√Ω:</h3>
          <div class="method-buttons">
            <div class="method-btn active" data-method="3">
              <strong>Bi·∫øn ƒë·ªïi √Çm b·∫£n</strong><br />
              <small>ƒê·∫£o ng∆∞·ª£c m√†u s·∫Øc ·∫£nh</small>
            </div>
            <div class="method-btn" data-method="1">
              <strong>Bi·∫øn ƒë·ªïi Log</strong><br />
              <small>TƒÉng c∆∞·ªùng v√πng t·ªëi</small>
            </div>
            <div class="method-btn" data-method="2">
              <strong>Bi·∫øn ƒë·ªïi M≈©</strong><br />
              <small>Hi·ªáu ch·ªânh Gamma</small>
            </div>
            <div class="method-btn" data-method="4">
              <strong>C√¢n b·∫±ng Histogram</strong><br />
              <small>C·∫£i thi·ªán ƒë·ªô t∆∞∆°ng ph·∫£n</small>
            </div>
            <div class="method-btn" data-method="5">
              <strong>Bi·∫øn ƒë·ªïi Tuy·∫øn t√≠nh t·ª´ng ƒëo·∫°n</strong><br />
              <small>TƒÉng c∆∞·ªùng c√°c v√πng c·ª• th·ªÉ</small>
            </div>
            <div class="method-btn" data-method="6">
              <strong>CLAHE</strong><br />
              <small>C·∫£i thi·ªán ƒë·ªô t∆∞∆°ng ph·∫£n c·ª•c b·ªô</small>
            </div>
          </div>

          <!-- Options Section -->
          <div class="options-section">
            <h4 style="margin-bottom: 15px; color: #333">
              ‚öôÔ∏è T√πy ch·ªçn X·ª≠ l√Ω:
            </h4>

            <!-- Grayscale Checkbox -->
            <div class="checkbox-wrapper">
              <input type="checkbox" id="grayscaleCheckbox" />
              <label for="grayscaleCheckbox"
                >üé® Chuy·ªÉn sang ·∫¢nh x√°m</label
              >
            </div>

            <!-- Use OpenCV Built-in Methods Checkbox -->
            <div class="checkbox-wrapper">
              <input type="checkbox" id="cv2Checkbox">
              <label for="cv2Checkbox">üîß S·ª≠ d·ª•ng h√†m OpenCV c√≥ s·∫µn</label>
            </div>

            <!-- Gamma Control for Power Transform -->
            <div class="gamma-control" id="gammaControl">
              <label for="gammaSlider"
                >Gi√° tr·ªã Gamma: <span id="gammaValue">0.5</span></label
              >
              <input
                type="range"
                id="gammaSlider"
                min="0.1"
                max="3.0"
                step="0.1"
                value="0.5"
              />
            </div>

            <!-- Piecewise Linear Control -->
            <div class="piecewise-control" id="piecewiseControl">
              <h5 style="margin-bottom: 10px; color: #333">
                üìä Bi·∫øn ƒë·ªïi Tuy·∫øn t√≠nh t·ª´ng ƒëo·∫°n
              </h5>
              <p style="margin-bottom: 15px; font-size: 14px; color: #666">
                Nh·∫•p v√†o ƒë·ªì th·ªã ƒë·ªÉ ƒë·∫∑t hai ƒëi·ªÉm ƒëi·ªÅu khi·ªÉn. H√†m s·∫Ω
                √°nh x·∫° c∆∞·ªùng ƒë·ªô ƒë·∫ßu v√†o th√†nh c∆∞·ªùng ƒë·ªô ƒë·∫ßu ra.
              </p>

              <div class="piecewise-graph-container">
                <canvas
                  id="piecewiseGraph"
                  class="piecewise-graph"
                  width="300"
                  height="300"
                ></canvas>
              </div>

              <div class="piecewise-info">
                <div class="point-info">
                  <div class="point-display">
                    <strong>ƒêi·ªÉm 1:</strong> (<span id="point1X">100</span>,
                    <span id="point1Y">50</span>)
                  </div>
                  <div class="point-display">
                    <strong>ƒêi·ªÉm 2:</strong> (<span id="point2X">200</span>,
                    <span id="point2Y">200</span>)
                  </div>
                </div>
                <button
                  class="reset-points-btn"
                  onclick="resetPiecewisePoints()"
                >
                  ƒê·∫∑t l·∫°i ƒêi·ªÉm
                </button>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 20px">
            <button class="process-btn" id="processBtn" disabled>
              ‚ö° X·ª≠ l√Ω ·∫¢nh
            </button>
          </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>ƒêang x·ª≠ l√Ω ·∫£nh...</p>
        </div>

        <!-- Error Display -->
        <div class="error" id="error"></div>

        <!-- Images Display -->
        <div class="images-section" id="imagesSection">
          <div class="image-container">
            <h4>üì∑ ·∫¢nh G·ªëc</h4>
            <div class="image-display" id="originalImage">
              <div class="placeholder">Ch∆∞a ch·ªçn ·∫£nh</div>
            </div>
          </div>
          <div class="image-container">
            <h4>‚ú® K·∫øt qu·∫£ Ph∆∞∆°ng ph√°p T·ª± vi·∫øt</h4>
            <div class="image-display" id="processedImage">
              <div class="placeholder">X·ª≠ l√Ω ·∫£nh ƒë·ªÉ xem k·∫øt qu·∫£</div>
            </div>
          </div>
          <div class="image-container" id="cv2ImageContainer" style="display: none;">
            <h4>üîß K·∫øt qu·∫£ Ph∆∞∆°ng ph√°p OpenCV</h4>
            <div class="image-display" id="cv2ProcessedImage">
              <div class="placeholder">K·∫øt qu·∫£ OpenCV s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</div>
            </div>
          </div>
        </div>

        <!-- Comparison Metrics Section -->
        <div class="comparison-section" id="comparisonSection">
          <div class="comparison-title">
            üìä So s√°nh Ph∆∞∆°ng ph√°p T·ª± vi·∫øt v√† Ph∆∞∆°ng ph√°p OpenCV
          </div>
          <div class="metrics-grid">
            <div class="metric-card mse">
              <div class="metric-label">MSE</div>
              <div class="metric-value" id="mseValue">-</div>
              <div class="metric-description">Sai s·ªë B√¨nh ph∆∞∆°ng Trung b√¨nh<br>(Th·∫•p h∆°n th√¨ t·ªët h∆°n)</div>
            </div>
            <div class="metric-card psnr">
              <div class="metric-label">PSNR</div>
              <div class="metric-value" id="psnrValue">-</div>
              <div class="metric-description">T·ª∑ s·ªë T√≠n hi·ªáu ƒê·ªânh tr√™n Nhi·ªÖu (dB)<br>(Cao h∆°n th√¨ t·ªët h∆°n)</div>
            </div>
            <div class="metric-card ssim">
              <div class="metric-label">SSIM</div>
              <div class="metric-value" id="ssimValue">-</div>
              <div class="metric-description">Ch·ªâ s·ªë T∆∞∆°ng ƒë·ªìng C·∫•u tr√∫c<br>(Cao h∆°n th√¨ t·ªët h∆°n, t·ªëi ƒëa=1)</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let selectedImage = null;
      let selectedMethod = "3";

      // Piecewise linear points
      let piecewisePoints = {
        point1: { x: 100, y: 50 },
        point2: { x: 200, y: 200 },
      };

      // DOM elements
      const imageInput = document.getElementById("imageInput");
      const originalImageDiv = document.getElementById("originalImage");
      const processedImageDiv = document.getElementById("processedImage");
      const processBtn = document.getElementById("processBtn");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");
      const methodBtns = document.querySelectorAll(".method-btn");
      const gammaControl = document.getElementById("gammaControl");
      const gammaSlider = document.getElementById("gammaSlider");
      const gammaValue = document.getElementById("gammaValue");
      const grayscaleCheckbox = document.getElementById("grayscaleCheckbox");
      const piecewiseControl = document.getElementById("piecewiseControl");
      const piecewiseCanvas = document.getElementById("piecewiseGraph");
      const ctx = piecewiseCanvas.getContext("2d");

      // CV2 comparison elements
      const cv2Checkbox = document.getElementById('cv2Checkbox');
      const comparisonSection = document.getElementById('comparisonSection');
      const cv2ImageContainer = document.getElementById('cv2ImageContainer');
      const cv2ProcessedImageDiv = document.getElementById('cv2ProcessedImage');
      const imagesSection = document.getElementById('imagesSection');

      // Initialize piecewise graph
      function initPiecewiseGraph() {
        drawPiecewiseGraph();
      }

      function drawPiecewiseGraph() {
        const canvas = piecewiseCanvas;
        const ctx = canvas.getContext("2d");

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw grid
        ctx.strokeStyle = "#e0e0e0";
        ctx.lineWidth = 1;

        // Vertical grid lines
        for (let i = 0; i <= 10; i++) {
          const x = (i / 10) * canvas.width;
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }

        // Horizontal grid lines
        for (let i = 0; i <= 10; i++) {
          const y = (i / 10) * canvas.height;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }

        // Draw axes
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 2;

        // X-axis
        ctx.beginPath();
        ctx.moveTo(0, canvas.height);
        ctx.lineTo(canvas.width, canvas.height);
        ctx.stroke();

        // Y-axis
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, canvas.height);
        ctx.stroke();

        // Draw piecewise function
        ctx.strokeStyle = "#667eea";
        ctx.lineWidth = 3;
        ctx.beginPath();

        // Convert points to canvas coordinates
        const p1_canvas = {
          x: (piecewisePoints.point1.x / 255) * canvas.width,
          y: canvas.height - (piecewisePoints.point1.y / 255) * canvas.height,
        };
        const p2_canvas = {
          x: (piecewisePoints.point2.x / 255) * canvas.width,
          y: canvas.height - (piecewisePoints.point2.y / 255) * canvas.height,
        };

        // Draw three line segments
        // Segment 1: (0,0) to point1
        ctx.moveTo(0, canvas.height);
        ctx.lineTo(p1_canvas.x, p1_canvas.y);

        // Segment 2: point1 to point2
        ctx.lineTo(p2_canvas.x, p2_canvas.y);

        // Segment 3: point2 to (255,255)
        ctx.lineTo(canvas.width, 0);

        ctx.stroke();

        // Draw control points
        ctx.fillStyle = "#dc3545";

        // Point 1
        ctx.beginPath();
        ctx.arc(p1_canvas.x, p1_canvas.y, 6, 0, 2 * Math.PI);
        ctx.fill();

        // Point 2
        ctx.beginPath();
        ctx.arc(p2_canvas.x, p2_canvas.y, 6, 0, 2 * Math.PI);
        ctx.fill();

        // Draw labels
        ctx.fillStyle = "#333";
        ctx.font = "12px Arial";
        ctx.fillText("(0,0)", 5, canvas.height - 5);
        ctx.fillText("(255,255)", canvas.width - 50, 15);

        // Update point displays
        document.getElementById("point1X").textContent =
          piecewisePoints.point1.x;
        document.getElementById("point1Y").textContent =
          piecewisePoints.point1.y;
        document.getElementById("point2X").textContent =
          piecewisePoints.point2.x;
        document.getElementById("point2Y").textContent =
          piecewisePoints.point2.y;
      }

      // Handle canvas clicks
      piecewiseCanvas.addEventListener("click", function (e) {
        const rect = piecewiseCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Convert to intensity values (0-255)
        const intensityX = Math.round((x / piecewiseCanvas.width) * 255);
        const intensityY = Math.round(
          ((piecewiseCanvas.height - y) / piecewiseCanvas.height) * 255
        );

        // Determine which point to update (closer one)
        const p1_canvas = {
          x: (piecewisePoints.point1.x / 255) * piecewiseCanvas.width,
          y:
            piecewiseCanvas.height -
            (piecewisePoints.point1.y / 255) * piecewiseCanvas.height,
        };
        const p2_canvas = {
          x: (piecewisePoints.point2.x / 255) * piecewiseCanvas.width,
          y:
            piecewiseCanvas.height -
            (piecewisePoints.point2.y / 255) * piecewiseCanvas.height,
        };

        const dist1 = Math.sqrt(
          (x - p1_canvas.x) ** 2 + (y - p1_canvas.y) ** 2
        );
        const dist2 = Math.sqrt(
          (x - p2_canvas.x) ** 2 + (y - p2_canvas.y) ** 2
        );

        if (dist1 < dist2) {
          piecewisePoints.point1 = { x: intensityX, y: intensityY };
        } else {
          piecewisePoints.point2 = { x: intensityX, y: intensityY };
        }

        // Ensure point1.x < point2.x
        if (piecewisePoints.point1.x > piecewisePoints.point2.x) {
          const temp = piecewisePoints.point1;
          piecewisePoints.point1 = piecewisePoints.point2;
          piecewisePoints.point2 = temp;
        }

        drawPiecewiseGraph();
      });

      function resetPiecewisePoints() {
        piecewisePoints = {
          point1: { x: 100, y: 50 },
          point2: { x: 200, y: 200 },
        };
        drawPiecewiseGraph();
      }

      // Image input handler
      imageInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            selectedImage = e.target.result;
            originalImageDiv.innerHTML = `<img src="${e.target.result}" alt="·∫¢nh G·ªëc">`;
            processBtn.disabled = false;
            hideError();
          };
          reader.readAsDataURL(file);
        }
      });

      // Method selection handlers
      methodBtns.forEach((btn) => {
        btn.addEventListener("click", function () {
          methodBtns.forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          selectedMethod = this.dataset.method;

          // Show/hide controls based on method
          gammaControl.classList.remove("show");
          piecewiseControl.classList.remove("show");

          if (selectedMethod === "2") {
            // Power transform
            gammaControl.classList.add("show");
          } else if (selectedMethod === "5") {
            // Piecewise linear
            piecewiseControl.classList.add("show");
          }
        });
      });

      // Gamma slider handler
      gammaSlider.addEventListener("input", function () {
        gammaValue.textContent = this.value;
      });

      // CV2 checkbox handler - Update layout when checkbox changes
      cv2Checkbox.addEventListener('change', function() {
        updateImageLayout();
      });

      function updateImageLayout() {
        if (cv2Checkbox.checked) {
          // Show 3 columns and CV2 container
          imagesSection.classList.add('three-columns');
          cv2ImageContainer.style.display = 'block';
        } else {
          // Show 2 columns and hide CV2 container
          imagesSection.classList.remove('three-columns');
          cv2ImageContainer.style.display = 'none';
          comparisonSection.classList.remove('show');
        }
      }

      // Process button handler
      processBtn.addEventListener("click", async function () {
        if (!selectedImage) {
          showError("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc");
          return;
        }

        showLoading();
        hideError();

        try {
          const formData = new FormData();
          
          // Convert base64 to blob and append as file
          const response = await fetch(selectedImage);
          const blob = await response.blob();
          formData.append("image", blob, "image.jpg");
          formData.append("method", selectedMethod);
          formData.append("grayscale", grayscaleCheckbox.checked);
          formData.append("use_cv2", cv2Checkbox.checked); // ƒê√¢y l√† flag ƒë·ªÉ hi·ªÉn th·ªã CV2 comparison
          
          if (selectedMethod === "2") {
            // Power transform
            formData.append("gamma", gammaSlider.value);
          } else if (selectedMethod === "5") {
            // Piecewise linear
            formData.append("r1", piecewisePoints.point1.x);
            formData.append("s1", piecewisePoints.point1.y);
            formData.append("r2", piecewisePoints.point2.x);
            formData.append("s2", piecewisePoints.point2.y);
          }

          const apiResponse = await fetch("/api/process-image", {
            method: "POST",
            body: formData,
          });

          const result = await apiResponse.json();

          if (result.success) {
            // Lu√¥n hi·ªÉn th·ªã k·∫øt qu·∫£ t·ª´ custom method
            processedImageDiv.innerHTML = `<img src="${result.processed_image}" alt="K·∫øt qu·∫£ Ph∆∞∆°ng ph√°p T·ª± vi·∫øt">`;
            
            // N·∫øu c√≥ y√™u c·∫ßu hi·ªÉn th·ªã so s√°nh CV2
            if (result.show_cv2_comparison && result.cv2_processed_image && result.comparison_metrics) {
              // Hi·ªÉn th·ªã k·∫øt qu·∫£ CV2
              cv2ProcessedImageDiv.innerHTML = `<img src="${result.cv2_processed_image}" alt="K·∫øt qu·∫£ Ph∆∞∆°ng ph√°p OpenCV">`;
              
              // C·∫≠p nh·∫≠t metrics so s√°nh
              document.getElementById('mseValue').textContent = result.comparison_metrics.mse.toFixed(4);
              document.getElementById('psnrValue').textContent = result.comparison_metrics.psnr.toFixed(2);
              document.getElementById('ssimValue').textContent = result.comparison_metrics.ssim.toFixed(4);
              
              // Hi·ªÉn th·ªã comparison section v√† layout 3 c·ªôt
              comparisonSection.classList.add('show');
              imagesSection.classList.add('three-columns');
              cv2ImageContainer.style.display = 'block';
            } else {
              // ·∫®n comparison section v√† tr·ªü v·ªÅ layout 2 c·ªôt
              comparisonSection.classList.remove('show');
              imagesSection.classList.remove('three-columns');
              cv2ImageContainer.style.display = 'none';
            }
          } else {
            showError(result.error || "X·ª≠ l√Ω th·∫•t b·∫°i");
          }
        } catch (err) {
          showError("L·ªói: " + err.message);
        } finally {
          hideLoading();
        }
      });

      // Utility functions
      function showLoading() {
        loading.classList.add("show");
        processBtn.disabled = true;
      }

      function hideLoading() {
        loading.classList.remove("show");
        processBtn.disabled = false;
      }

      function showError(message) {
        error.textContent = message;
        error.classList.add("show");
      }

      function hideError() {
        error.classList.remove("show");
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        initPiecewiseGraph();
        updateImageLayout(); // Set initial layout
      });
    </script>
  </body>
</html>